#!/bin/bash

set -e

echo "ğŸ” Running pre-commit checks..."

# 1. git-secret: Automatic encryption of secret files
if command -v git-secret &> /dev/null; then
  echo "ğŸ”’ Encrypting secrets with git-secret..."

  # Check for changes in secret files
  changed_secrets=$(git secret list 2>/dev/null | xargs -I {} sh -c 'git diff --cached --name-only | grep -x {} || true')

  if [ -n "$changed_secrets" ]; then
    echo "  â†³ Detected changes in secret files: $changed_secrets"
    git secret hide -m

    # Automatically stage encrypted files
    for file in $(git secret list 2>/dev/null); do
      if [ -f "${file}.secret" ]; then
        git add "${file}.secret"
        echo "  âœ“ Added ${file}.secret to staging"
      fi
    done
  else
    echo "  âœ“ No secret files changed"
  fi
else
  echo "  âš ï¸  git-secret not found, skipping encryption"
fi

# 2. Linting and Formatting
echo "ğŸ“ Running Biome checks..."
if ! npm run check; then
  echo "âŒ Biome check failed. Please fix the errors and try again."
  exit 1
fi
echo "  âœ“ Biome check passed"

# 3. Type checking (only if tsconfig.json exists)
if [ -f "tsconfig.json" ]; then
  echo "ğŸ” Running TypeScript type check..."
  if ! npm run typecheck; then
    echo "âŒ Type check failed. Please fix the errors and try again."
    exit 1
  fi
  echo "  âœ“ Type check passed"
else
  echo "â­ï¸  Skipping TypeScript type check (tsconfig.json not found)"
fi

# 4. Tests (only if test setup exists)
if [ -f "vitest.config.ts" ] || [ -d "src/test" ]; then
  echo "ğŸ§ª Running tests..."
  if ! npm run test:run; then
    echo "âŒ Tests failed. Please fix the tests and try again."
    exit 1
  fi
  echo "  âœ“ Tests passed"
else
  echo "â­ï¸  Skipping tests (test configuration not found)"
fi

echo "âœ… All pre-commit checks passed!"
