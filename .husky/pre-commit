#!/bin/bash

set -e

echo "ğŸ” Running pre-commit checks..."

# 1. git-secret: Automatic encryption of secret files
if command -v git-secret &> /dev/null; then
  echo "ğŸ”’ Encrypting secrets with git-secret..."

  # Check for changes in secret files
  changed_secrets=$(git secret list 2>/dev/null | xargs -I {} sh -c 'git diff --cached --name-only | grep -x {} || true')

  if [ -n "$changed_secrets" ]; then
    echo "  â†³ Detected changes in secret files: $changed_secrets"
    git secret hide -m

    # Automatically stage encrypted files
    for file in $(git secret list 2>/dev/null); do
      if [ -f "${file}.secret" ]; then
        git add "${file}.secret"
        echo "  âœ“ Added ${file}.secret to staging"
      fi
    done
  else
    echo "  âœ“ No secret files changed"
  fi
else
  echo "  âš ï¸  git-secret not found, skipping encryption"
fi

# 2. Tests (only if test setup exists)
# pretest hook automatically runs Biome checks
if [ -f "vite.config.ts" ] && grep -q "test:" vite.config.ts; then
  echo "ğŸ§ª Running tests (with pretest checks)..."
  if ! npm test; then
    echo "âŒ Tests failed. Please fix the tests and try again."
    exit 1
  fi
  echo "  âœ“ Tests passed"
else
  echo "â­ï¸  Skipping tests (test configuration not found)"
fi

# 3. Build verification (only if vite.config.ts exists)
# prebuild hook automatically runs Biome checks and TypeScript type check
if [ -f "vite.config.ts" ]; then
  echo "ğŸ—ï¸  Running build verification (with prebuild checks)..."
  if ! npm run build; then
    echo "âŒ Build failed. Please fix the errors and try again."
    exit 1
  fi
  echo "  âœ“ Build verification passed"
else
  echo "â­ï¸  Skipping build verification (vite.config.ts not found)"
fi

echo "âœ… All pre-commit checks passed!"
